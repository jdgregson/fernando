<!DOCTYPE html>
<html>
<head>
    <title>fernando</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#1e1e1e">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.1.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.7.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.8.0/lib/xterm-addon-web-links.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.1.0/css/xterm.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: monospace; background: #1e1e1e; color: #fff; display: flex; flex-direction: column; }
        
        .top-bar {
            background: #252526;
            border-bottom: 1px solid #3e3e42;
            padding: 4px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 28px;
        }
        
        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .top-bar-title {
            font-size: 14px;
            font-weight: bold;
        }
        
        .top-bar button {
            background: #4e9a06;
            border: none;
            color: #2e3436;
            padding: 4px 10px;
            cursor: pointer;
            border-radius: 0;
            font-size: 12px;
            font-family: monospace;
        }
        
        .top-bar button:hover {
            background: #5fb207;
        }
        
        .content-wrapper {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .sidebar {
            width: 250px;
            background: #252526;
            border-right: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: transform 0.3s;
        }
        
        .sidebar-header {
            display: none;
        }
        
        .sidebar-toggle {
            display: none;
        }
        
        @media (max-width: 500px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 28px;
                bottom: 0;
                z-index: 999;
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .sidebar-toggle {
                display: block;
            }
        }
        
        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #3e3e42;
            font-size: 18px;
            font-weight: bold;
        }
        
        .session-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .session-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .session-item:hover {
            background: #2a2d2e;
        }
        
        .session-item.active {
            background: #4e9a06;
        }
        
        .session-name {
            flex: 1;
        }
        
        .close-btn {
            background: #c72e2e;
            border: none;
            color: white;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 11px;
        }
        
        .close-btn:hover {
            background: #e81123;
        }
        
        .new-session {
            padding: 15px;
            border-top: 1px solid #3e3e42;
        }
        
        .new-session input {
            width: 100%;
            padding: 8px;
            background: #3c3c3c;
            border: 1px solid #3e3e42;
            color: #fff;
            margin-bottom: 8px;
        }
        
        .new-session button {
            width: 100%;
            padding: 8px;
            background: #4e9a06;
            border: none;
            color: #2e3436;
            cursor: pointer;
            border-radius: 0;
            font-family: monospace;
        }
        
        .new-session button:hover {
            background: #5fb207;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .terminals-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .terminal-container {
            flex: 1;
            position: relative;
            border-bottom: 1px solid #3e3e42;
            border: 2px solid transparent;
        }
        
        .terminal-container:last-child {
            border-bottom: none;
        }
        
        .terminal-container.hidden {
            display: none;
        }
        
        .terminal-container.active.split-mode {
            border: 2px solid #4e9a06;
        }
        
        .terminal {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        .terminal .xterm {
            width: 100% !important;
            height: 100% !important;
        }
        
        .browser-pane {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1e1e1e;
        }
        
        .browser-pane.hidden {
            display: none;
        }
        
        .browser-pane iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .pane-type-selector {
            display: none;
        }
        
        .split-controls {
            display: none;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #c72e2e;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            z-index: 1000;
            animation: fadeInOut 2s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(10px); }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="top-bar-left">
            <button class="sidebar-toggle" onclick="toggleSidebar()">☰</button>
            <span class="top-bar-title">fernando</span>
        </div>
        <div>
            <button onclick="toggleDesktop()">Desktop</button>
            <button onclick="toggleSplit()">Split</button>
        </div>
    </div>
    <div class="content-wrapper">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">fernando</div>
            <div class="session-list" id="sessionList">
                {% for session in sessions %}
                <div class="session-item" data-session="{{ session }}">
                    <span class="session-name">{{ session }}</span>
                    <button class="close-btn" onclick="closeSession(event, '{{ session }}')">✕</button>
                </div>
                {% endfor %}
            </div>
            <div class="new-session">
                <input type="text" id="newSessionName" placeholder="New session name" />
                <button onclick="createSession()">Create Session</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="terminals-wrapper">
                <div class="terminal-container active" id="terminal1-container">
                    <div class="terminal" id="terminal1"></div>
                    <div class="browser-pane hidden" id="browser1"></div>
                </div>
                <div class="terminal-container hidden" id="terminal2-container">
                    <div class="terminal" id="terminal2"></div>
                    <div class="browser-pane hidden" id="browser2"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
    
    <script>
        const socket = io({
            path: window.location.pathname.replace(/\/$/, '') + '/socket.io',
            reconnection: true,
            reconnectionDelay: 500,
            reconnectionAttempts: 10
        });
        
        let isSplit = false;
        let activeTerminal = 1;
        let paneTypes = { 1: 'terminal', 2: 'terminal' };
        let desktopMode = false;
        let isReconnecting = false;
        
        // Handle iOS backgrounding/foregrounding
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                console.log('App foregrounded, reconnecting...');
                handleForeground();
            }
        });
        
        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                console.log('Page restored from cache, reconnecting...');
                handleForeground();
            }
        });
        
        function handleForeground() {
            // Reconnect socket if disconnected
            if (!socket.connected) {
                socket.connect();
            }
            
            // Reattach sessions
            if (currentSession1 && paneTypes[1] === 'terminal') {
                setTimeout(() => {
                    term1.clear();
                    socket.emit('attach_session', { terminal: 1, session: currentSession1 });
                    setTimeout(doFit, 100);
                }, 200);
            }
            
            if (currentSession2 && paneTypes[2] === 'terminal' && isSplit) {
                setTimeout(() => {
                    term2.clear();
                    socket.emit('attach_session', { terminal: 2, session: currentSession2 });
                    setTimeout(doFit, 100);
                }, 200);
            }
            
            // Reload browser iframes
            reloadBrowserPanes();
        }
        
        function reloadBrowserPanes() {
            [1, 2].forEach(paneNum => {
                if (paneTypes[paneNum] === 'browser') {
                    const browser = document.getElementById(`browser${paneNum}`);
                    const iframe = browser.querySelector('iframe');
                    if (iframe) {
                        console.log(`Reloading browser pane ${paneNum}`);
                        iframe.src = iframe.src; // Force reload
                    }
                }
            });
        }
        
        socket.on('reconnect', () => {
            console.log('Socket reconnected');
            handleForeground();
        });
        
        const term1 = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            fontFamily: 'Menlo, Monaco, "Courier New", monospace',
            theme: { background: '#1e1e1e' }
        });
        
        const term2 = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            fontFamily: 'Menlo, Monaco, "Courier New", monospace',
            theme: { background: '#1e1e1e' }
        });
        
        term1.open(document.getElementById('terminal1'));
        term2.open(document.getElementById('terminal2'));
        
        console.log('Terminals opened');
        console.log('Terminal1 element:', document.getElementById('terminal1'));
        console.log('Terminal2 element:', document.getElementById('terminal2'));
        
        const fitAddon1 = new FitAddon.FitAddon();
        const fitAddon2 = new FitAddon.FitAddon();
        const webLinksAddon1 = new WebLinksAddon.WebLinksAddon();
        const webLinksAddon2 = new WebLinksAddon.WebLinksAddon();
        term1.loadAddon(fitAddon1);
        term1.loadAddon(webLinksAddon1);
        term2.loadAddon(fitAddon2);
        term2.loadAddon(webLinksAddon2);
        
        console.log('Fit addons loaded');
        
        function toggleDesktop() {
            const activePane = activeTerminal;
            const browser = document.getElementById(`browser${activePane}`);
            const terminal = document.getElementById(`terminal${activePane}`);
            
            if (paneTypes[activePane] === 'terminal') {
                paneTypes[activePane] = 'browser';
                terminal.classList.add('hidden');
                browser.classList.remove('hidden');
                
                // Clear session tracking when switching to browser
                if (activePane === 1) {
                    currentSession1 = null;
                } else {
                    currentSession2 = null;
                }
                
                // Remove existing iframe and create fresh one
                browser.innerHTML = '';
                const iframe = document.createElement('iframe');
                iframe.src = '/kasm/?resize=remote';
                iframe.allow = 'autoplay; clipboard-read; clipboard-write';
                browser.appendChild(iframe);
            } else {
                paneTypes[activePane] = 'terminal';
                terminal.classList.remove('hidden');
                browser.classList.add('hidden');
                setTimeout(doFit, 100);
            }
        }
        
        function setPaneType(paneNum, type) {
            paneTypes[paneNum] = type;
            const container = document.getElementById(`terminal${paneNum}-container`);
            const terminal = document.getElementById(`terminal${paneNum}`);
            const browser = document.getElementById(`browser${paneNum}`);
            const buttons = container.querySelectorAll('.pane-type-selector button');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (type === 'terminal') {
                terminal.classList.remove('hidden');
                browser.classList.add('hidden');
                setTimeout(doFit, 100);
            } else {
                terminal.classList.add('hidden');
                browser.classList.remove('hidden');
                if (!browser.querySelector('iframe')) {
                    browser.innerHTML = '<iframe src="/kasm/?resize=remote"></iframe>';
                }
            }
        }
        
        function doFit() {
            console.log('doFit called');
            if (paneTypes[1] === 'terminal') {
                fitAddon1.fit();
                console.log('Term1 fitted:', term1.rows, term1.cols);
                socket.emit('resize', { terminal: 1, rows: term1.rows, cols: term1.cols });
            }
            if (isSplit && paneTypes[2] === 'terminal') {
                fitAddon2.fit();
                console.log('Term2 fitted:', term2.rows, term2.cols);
                socket.emit('resize', { terminal: 2, rows: term2.rows, cols: term2.cols });
            }
        }
        
        let currentSession1 = null;
        let currentSession2 = null;
        
        term1.onData(data => {
            socket.emit('input', { terminal: 1, data: data });
        });
        
        term2.onData(data => {
            socket.emit('input', { terminal: 2, data: data });
        });
        
        socket.on('output', data => {
            console.log('Received output for terminal', data.terminal, 'length:', data.data.length);
            if (data.terminal === 1) {
                term1.write(data.data);
            } else if (data.terminal === 2) {
                term2.write(data.data);
            }
        });
        
        socket.on('session_created', data => {
            location.reload();
        });
        
        socket.on('session_closed', data => {
            location.reload();
        });
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }
        
        function attachSession(sessionName) {
            console.log('Attaching session:', sessionName, 'to terminal:', activeTerminal);
            
            // If browser is showing, switch to terminal first
            if (paneTypes[activeTerminal] === 'browser') {
                toggleDesktop();
            }
            
            if (activeTerminal === 1 && currentSession2 === sessionName) {
                showToast('Session already attached to Terminal 2');
                return;
            } else if (activeTerminal === 2 && currentSession1 === sessionName) {
                showToast('Session already attached to Terminal 1');
                return;
            }
            
            const term = activeTerminal === 1 ? term1 : term2;
            term.clear();
            
            if (activeTerminal === 1) {
                currentSession1 = sessionName;
            } else {
                currentSession2 = sessionName;
            }
            
            socket.emit('attach_session', { terminal: activeTerminal, session: sessionName });
            console.log('Emitted attach_session');
            
            setTimeout(doFit, 100);
        }
        
        function toggleSplit() {
            isSplit = !isSplit;
            const container2 = document.getElementById('terminal2-container');
            
            if (isSplit) {
                container2.classList.remove('hidden');
                setActiveTerminal(2);
            } else {
                container2.classList.add('hidden');
                setActiveTerminal(1);
            }
            
            setTimeout(doFit, 100);
        }
        
        function setActiveTerminal(termNum) {
            console.log('Setting active terminal to:', termNum);
            activeTerminal = termNum;
            const term1Container = document.getElementById('terminal1-container');
            const term2Container = document.getElementById('terminal2-container');
            
            term1Container.classList.toggle('active', termNum === 1);
            term2Container.classList.toggle('active', termNum === 2);
            
            // Add split-mode class to both when split
            if (isSplit) {
                term1Container.classList.add('split-mode');
                term2Container.classList.add('split-mode');
            } else {
                term1Container.classList.remove('split-mode');
                term2Container.classList.remove('split-mode');
            }
        }
        
        // Click handlers to switch active terminal
        document.getElementById('terminal1-container').addEventListener('click', (e) => {
            console.log('Terminal 1 clicked');
            setActiveTerminal(1);
            e.stopPropagation();
        });
        
        document.getElementById('terminal2-container').addEventListener('click', (e) => {
            console.log('Terminal 2 clicked');
            if (isSplit) {
                setActiveTerminal(2);
            }
            e.stopPropagation();
        });
        
        function createSession() {
            const name = document.getElementById('newSessionName').value.trim();
            if (!name) {
                alert('Enter session name');
                return;
            }
            socket.emit('create_session', { name: name });
            document.getElementById('newSessionName').value = '';
        }
        
        function closeSession(event, sessionName) {
            event.stopPropagation();
            if (confirm(`Close session "${sessionName}"?`)) {
                socket.emit('close_session', { session: sessionName });
            }
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }
        
        // Click handler for session items
        document.querySelectorAll('.session-item').forEach(item => {
            item.addEventListener('click', function() {
                const sessionName = this.dataset.session;
                attachSession(sessionName);
                // Close sidebar on mobile after selection
                if (window.innerWidth <= 500) {
                    document.getElementById('sidebar').classList.remove('open');
                }
            });
        });
        
        // Auto-attach to first session if exists
        const firstSession = document.querySelector('.session-item');
        if (firstSession) {
            attachSession(firstSession.dataset.session);
        }
        
        // Fit on window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(doFit, 100);
        });
        
        // Force initial fit multiple times to ensure it works
        setTimeout(doFit, 100);
        setTimeout(doFit, 300);
        setTimeout(doFit, 500);
        setTimeout(doFit, 1000);
    </script>
</body>
</html>
